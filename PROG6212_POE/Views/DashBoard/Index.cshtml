@using System.Security.Claims
@using PROG6212_POE.Models
@{
    ViewData["Title"] = "Dashboard";
    string role = User.FindFirst(ClaimTypes.Role)?.Value ?? "";
    var recent = ViewBag.RecentClaims as System.Collections.Generic.IReadOnlyList<ClaimDto>;
}

<h2 class="mb-4">Welcome, @User.Identity?.Name</h2>

@if (role == "Lecturer")
{
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <a asp-controller="Dashboard" asp-action="SubmitClaim" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <h5 class="mb-1">Submit Claim</h5>
                        <div class="text-muted small">Capture date, hours, rate and upload doc.</div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a asp-controller="Dashboard" asp-action="MyClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <h5 class="mb-1">My Claims</h5>
                        <div class="text-muted small">View statuses, filter and search.</div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    @if (recent != null && recent.Any())
    {
        <div class="card">
            <div class="card-header bg-white fw-semibold">Recent Claims</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hours</th>
                                <th>Activity</th>
                                <th>Rate (R)</th>
                                <th>Total (R)</th>
                                <th>Status</th>
                                <th style="min-width:160px;">Progress</th>
                                <th>Docs</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in recent)
                            {
                                var width = c.Status == ClaimStatus.Submitted ? 33 : c.Status == ClaimStatus.UnderReview ? 66 : 100;
                                var barClass = c.Status == ClaimStatus.Approved ? "bg-success" :
                                c.Status == ClaimStatus.Rejected ? "bg-danger" : "bg-info";
                                <tr>
                                    <td>@c.DateWorked.ToString("yyyy-MM-dd")</td>
                                    <td>@c.HoursWorked</td>
                                    <td>@c.Activity</td>
                                    <td>@c.HourlyRate.ToString("N2")</td>
                                    <td>@c.TotalAmount.ToString("N2")</td>
                                    <td><span class="claim-status" data-id="@c.ClaimId">@c.Status</span></td>
                                    <td>
                                        <div class="progress" style="height:8px;">
                                            <div class="progress-bar @barClass" data-id="@c.ClaimId" style="width:@width%"></div>
                                        </div>
                                    </td>
                                    <td>
                                        @if (c.Documents?.Any() ?? false)
                                        {
                                            foreach (var d in c.Documents)
                                            {
                                                <a href="@d.RelativePath" target="_blank">@d.FileName</a>
                                                <br />
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">None</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
}
else if (role == "ProgrammeCoordinator" || role == "AcademicManager")
{
    <div class="row g-3">
        <div class="col-md-4">
            <a asp-controller="Management" asp-action="ReviewClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <h5 class="mb-1">Review Claims</h5>
                        <div class="text-muted small">Approve or reject with comments.</div>
                    </div>
                </div>
            </a>
        </div>
    </div>
}

@section Scripts {
    <script>
        const statusPercent = s => s==="Submitted"?33:(s==="UnderReview"?66:100);
        const statusClass = s => s==="Approved"?"bg-success":(s==="Rejected"?"bg-danger":"bg-info");
        function refreshStatuses(){
          fetch('@Url.Action("MyClaimsStatusData", "Dashboard")',{cache:"no-store"})
           .then(r=>r.json()).then(items=>{
             items.forEach(it=>{
               const span=document.querySelector(`span.claim-status[data-id='${it.id}']`);
               const bar=document.querySelector(`div.progress-bar[data-id='${it.id}']`);
               if(span) span.textContent=it.status;
               if(bar){ bar.style.width=statusPercent(it.status)+"%"; bar.className="progress-bar "+statusClass(it.status); }
             });
           }).catch(()=>{});
        }
        refreshStatuses(); setInterval(refreshStatuses, 10000);
    </script>
}