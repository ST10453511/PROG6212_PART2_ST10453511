@model System.Collections.Generic.IReadOnlyList<PROG6212_POE.Models.ClaimDto>
@using PROG6212_POE.Models
@{
    ViewData["Title"] = "My Claims";
}
<div class="card">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <span class="fw-semibold">My Claims</span>
        <div class="d-flex gap-2">
            <input id="search" class="form-control form-control-sm" placeholder="Search activity..." />
            <select id="status" class="form-select form-select-sm" style="width:12rem">
                <option value="">All statuses</option>
                <option>Submitted</option>
                <option>UnderReview</option>
                <option>Approved</option>
                <option>Rejected</option>
            </select>
        </div>
    </div>
    <div class="card-body p-0">
        @if (Model == null || !Model.Any())
        {
            <div class="p-4 text-muted">No claims yet.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-sm align-middle mb-0" id="tbl">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Hours</th>
                            <th>Activity</th>
                            <th>Rate (R)</th>
                            <th>Total (R)</th>
                            <th>Status</th>
                            <th style="min-width:160px;">Progress</th>
                            <th>Docs</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model)
                        {
                            var width = c.Status == ClaimStatus.Submitted ? 33 :
                            c.Status == ClaimStatus.UnderReview ? 66 : 100;
                            var barClass = c.Status == ClaimStatus.Approved ? "bg-success" :
                            c.Status == ClaimStatus.Rejected ? "bg-danger" : "bg-info";
                            <tr data-status="@c.Status" data-act="@c.Activity.ToLowerInvariant()">
                                <td>@c.DateWorked.ToString("yyyy-MM-dd")</td>
                                <td>@c.HoursWorked</td>
                                <td>@c.Activity</td>
                                <td>@c.HourlyRate.ToString("N2")</td>
                                <td>@c.TotalAmount.ToString("N2")</td>
                                <td><span class="claim-status" data-id="@c.ClaimId">@c.Status</span></td>
                                <td>
                                    <div class="progress" style="height:8px;">
                                        <div class="progress-bar @barClass" data-id="@c.ClaimId" style="width:@width%"></div>
                                    </div>
                                </td>
                                <td>
                                    @if (c.Documents.Any())
                                    {
                                        foreach (var d in c.Documents)
                                        {
                                            <a href="@d.RelativePath" target="_blank">@d.FileName</a>
                                            <br />
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">None</span>
                                    }
                                </td>
                                <td>@c.SubmittedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        const statusPercent = s => s==="Submitted"?33:(s==="UnderReview"?66:100);
        const statusClass = s => s==="Approved"?"bg-success":(s==="Rejected"?"bg-danger":"bg-info");

        function refreshStatuses(){
          fetch('@Url.Action("MyClaimsStatusData", "Dashboard")',{cache:"no-store"})
            .then(r=>r.json()).then(items=>{
              items.forEach(it=>{
                const span=document.querySelector(`span.claim-status[data-id='${it.id}']`);
                const bar=document.querySelector(`div.progress-bar[data-id='${it.id}']`);
                if(span) span.textContent=it.status;
                if(bar){ bar.style.width=statusPercent(it.status)+"%"; bar.className="progress-bar "+statusClass(it.status); }
              });
            }).catch(()=>{});
        }
        refreshStatuses(); setInterval(refreshStatuses, 10000);

        // client filter/search
        const txt=document.getElementById('search'), sel=document.getElementById('status');
        function applyFilter(){
          const q=(txt.value||"").toLowerCase(), s=sel.value;
          document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
             const okS = !s || tr.dataset.status===s;
             const okQ = !q || tr.dataset.act.includes(q);
             tr.style.display = (okS && okQ) ? "" : "none";
          });
        }
        txt.addEventListener('input', applyFilter);
        sel.addEventListener('change', applyFilter);
    </script>
}